<?php
/**
 * @package   QWcrm
 * @author    Jon Brown https://quantumwarp.com/
 * @copyright Copyright (C) 2016 - 2017 Jon Brown, All rights reserved.
 * @license   GNU/GPLv3 or later; https://www.gnu.org/licenses/gpl.html
 */

defined('_QWEXEC') or die;

// Prevent undefined variable errors
\CMSApplication::$VAR['login_username'] = isset(\CMSApplication::$VAR['login_username']) ? \CMSApplication::$VAR['login_username'] : null;
\CMSApplication::$VAR['login_pwd'] = isset(\CMSApplication::$VAR['login_pwd']) ? \CMSApplication::$VAR['login_pwd'] : null;
\CMSApplication::$VAR['action'] = isset(\CMSApplication::$VAR['action']) ? \CMSApplication::$VAR['action'] : null;

// Get variables in correct format for login()
$credentials['username'] = \CMSApplication::$VAR['login_username'];
$credentials['password'] = \CMSApplication::$VAR['login_pwd'];
if ($this->app->config->get('remember_me') && isset(\CMSApplication::$VAR['remember'])) {
    $options['remember'] = \CMSApplication::$VAR['remember'];
} else {
    $options = array();
}

// If login submitted 
if(\CMSApplication::$VAR['action'] === 'login') {
    
    // recaptcha is disabled || recaptcha is enabled and passes authentication
    if(!$this->app->config->get('recaptcha') || ($this->app->config->get('recaptcha') && $this->app->components->user->authenticateRecaptcha($this->app->config->get('recaptcha_secret_key'), \CMSApplication::$VAR['g-recaptcha-response']))) {

        /* Allowed to submit */        

        // Log the user in
        if($this->app->components->user->login(\CMSApplication::$VAR, $credentials, $options)) {

            $this->app->system->page->forcePage('index.php');

        } else {
            // do nothing reload login page
        }
            
        

    } else {

        /* Failed reCAPTCHA  */         

        // Allow login page to load with reCAPTCHA warning message (already generated by $this->app->components->user->authenticate_recaptcha())

    }
    
}

// Remove credentials and options as no longer needed
unset($credentials);
unset($options);

// If logout is set, then log the user off
if (\CMSApplication::$VAR['action'] == 'logout') {    
    $this->app->components->user->logout();
}

// Build the page
$this->app->smarty->assign('remember_me', $this->app->config->get('remember_me'));
$this->app->smarty->assign('recaptcha', $this->app->config->get('recaptcha'));
$this->app->smarty->assign('recaptcha_site_key', $this->app->config->get('recaptcha_site_key'));

